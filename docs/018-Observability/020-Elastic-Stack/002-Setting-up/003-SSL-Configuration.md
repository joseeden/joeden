---
title: "SSL/TLS Configuration"
description: "SSL/TLS Configuration"
tags: 
- Linux
- Observability
- DevOps
- Monitoring 
- APM
- Elasticsearch
- Elastic Stack
- ELK Stack
sidebar_position: 3
last_update:
  date: 3/28/2023
---


## Checking SSL 

To check if SSL/TLS is enabled, check `/etc/elasticsearch/elasticsearch.yml`:

```bash
# Enable security features
xpack.security.enabled: true

xpack.security.enrollment.enabled: true

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12 
```


## Built-in Certificates 

These certificates are typically self-signed by Elasticsearch during the initial setup if no custom certificates are provided. 

1. Server Certificate (`http.p12`):

    This is the **server certificate** used for HTTP communications (HTTPS) between Elasticsearch and external clients (e.g., Kibana, Logstash, and Agents).

    - Contains the public certificate and the private key.
    - Verifies clients are connecting to the correct server.
    - Ensures clients can securely communicate using HTTPS.

2. Transport SSL Certificate (`transport.p12`):

    This is used for **node-to-node encryption**. It ensures that communications between different Elasticsearch nodes within the cluster are encrypted and secure.

    - Contains certificates and keys for mutual TLS authentication.
    - Used between Elasticsearch nodes in the cluster.


## Custom Certificates

You can replace the auto-generated server certificates with your own custom certificates by modifying the configuration file.

- If using an untrusted certificate, distribute it to all systems that need to trust it.
- For internal use, you can use a self-signed certificate or one from an internal CA.
- Set up internal trust stores to recognize the certificate.
- Ensure the `.p12` format is supported by your systems (e.g., Elasticsearch, Kibana).
- Store the private key and certificate securely.

For node-to-node encryption in Elasticsearch:

- Create your own self-signed certificate or one from an internal CA for mutual TLS (mTLS).
- Configure both the private key and certificate on each node.
- Ensure all nodes trust the certificate.
- Add the root CA certificate to each node's trust store if needed.
- Update `elasticsearch.yml` on each node with the correct certificate and key paths.
- Secure the private key to prevent unauthorized access.


## Trust the CA Certificate

When configuring SSL/TLS for secure communication between Elasticsearch and clients, it is important to trust the Certificate Authority (CA) certificate to ensure the authenticity of the server. 

1. Add the self-signed CA certificate to the trusted certificates directory:

    ```bash
    cp /etc/elasticsearch/certs/http_ca.crt /usr/share/ca-certificates/elastic-ca.crt 
    ```

    This certificate is the Certificate Authority (CA) certificate generated by Elasticsearch during its security auto-configuration process. It is a self-signed certificate used to secure HTTP communication between Elasticsearch clients and the server by enabling SSL/TLS encryption.

    If you are using your own certificate, specify it instead:

    ```bash
    cp /etc/elasticsearch/certs/myown_ca.crt /usr/share/ca-certificates/myown-ca.crt 
    ``` 

    :::info 

    This is generally used for **system-wide trust** on the machine/s where you're copying the certificate. If you're adding the CA certificate to your machine's list of trusted certificates (for example, for system-level applications like browsers or other services), this method is appropriate.

    :::

2. If you're using Ubuntu or Debian-based system, run the command below.

    ```bash
    dpkg-reconfigure ca-certificates
    ```

4.  When prompted, click Yes. 

    ![](/img/docs/12152024-Observability-elastic-config-ssl.png)

4. Select the copied certificate by pressing spacebar > Enter 

    ![](/img/docs/12152024-Observability-elastic-config-ssl-2.png)

5. Verify that the SSL certificate works.

    ```bash
    curl -u elastic:<add-password>  https://localhost:9200
    ```

    Output:

    ```bash
    {
    "name" : "elasticsearch",
    "cluster_name" : "elasticsearch",
    "cluster_uuid" : "Lmfoq9mbRBqis3GvrLVTZw",
    "version" : {
        "number" : "8.17.0",
        "build_flavor" : "default",
        "build_type" : "deb",
        "build_hash" : "2b6a7fed44faa321997703718f07ee0420804b41",
        "build_date" : "2024-12-11T12:08:05.663969764Z",
        "build_snapshot" : false,
        "lucene_version" : "9.12.0",
        "minimum_wire_compatibility_version" : "7.17.0",
        "minimum_index_compatibility_version" : "7.0.0"
    },
    "tagline" : "You Know, for Search"
    }
    ```


## Share the CA Certificate to Other VMs (Optional)

..short intro why we need this..2 sentences

To use the Elasticsearch SSL certificate on other VMs, follow these steps:

1. On the Elasticsearch VM, generate the SSH key.

    ```bash
    ssh-keygen -t ecdsa -b 521 -f ~/.ssh/id_ecdsa 
    ```

2. Get the public key.

    ```bash
    cat ~/.ssh/id_ecdsa.pub
    ```

3. On the other VM, add the Elasticsearch VM's public key to the `authorized_keys` file.

    ```bash
    cat >> ~/.ssh/authorized_keys 
    ```

    Paste the copied public key and hit `Ctrl + D`.

4. From the Elasticsearch VM, share the certificate to the other VM using `scp`.
    Make sure to change the IP address of the other VM.

    ```bash
    scp /etc/elasticsearch/certs/http_ca.crt root@192.168.56.103:/tmp
    ```

5. Go back to the other VM and move the shared certificate.

    ```bash
    sudo su 
    mv /tmp/http_ca.crt /usr/share/ca-certificates/elastic-ca.crt
    ```

    ```

6. Similar to the Elasticsearch node, reconfigure the CA certificates on the other VM to trust the new cert.

    ```bash
    dpkg-reconfigure ca-certificates
    ```

7.  When prompted, click Yes. 

    ![](/img/docs/12152024-Observability-elastic-config-ssl.png)

8. Select the copied certificate by pressing spacebar > Enter 

    ![](/img/docs/12152024-Observability-elastic-config-ssl-2.png)


9. From the other VM, test the connection:

    ```bash
    $ curl -s -k  -u elastic:<password> https://192.168.56.101:9200 | jq

    {
      "name": "node1",
      "cluster_name": "elasticsearch",
      "cluster_uuid": "QyCE0sgfQci-KgVx7mc5bA",
      "version": {
        "number": "8.17.0",
        "build_flavor": "default",
        "build_type": "deb",
        "build_hash": "2b6a7fed44faa321997703718f07ee0420804b41",
        "build_date": "2024-12-11T12:08:05.663969764Z",
        "build_snapshot": false,
        "lucene_version": "9.12.0",
        "minimum_wire_compatibility_version": "7.17.0",
        "minimum_index_compatibility_version": "7.0.0"
      },
      "tagline": "You Know, for Search"
    } 
    ```

    Elasticsearch node has the IP: 192.168.56.101


## Creating a Truststore

In Logstash, you may need to configure a truststore if you're using SSL/TLS communication with Elasticsearch, especially when working with self-signed certificates. A truststore ensures that Logstash can trust the server certificate from Elasticsearch for secure communication.

If you have a self-signed certificate, you'll need to convert your server’s certificate into a valid .jks (Java KeyStore) file.

1. Download the server's certificate (the one your Elasticsearch instance is using) if you don’t already have it.

    ```bash
    openssl s_client -showcerts -connect MYURL:MYPORT </dev/null 2>/dev/null | openssl x509 -outform PEM > downloaded_cert.pem
    ```

    Replace MYURL with your server's URL and MYPORT with the port number (usually 443 for HTTPS). For example:

    ```bash
    openssl s_client -showcerts -connect 192.168.56.101:9200 </dev/null 2>/dev/null  | openssl x509 -outform PEM > downloaded_cert.pem 
    ```

    This will save the certificate in the `downloaded_cert.pem` file.

2. Next, you need to convert the downloaded PEM certificate into a Java keystore file (.jks).

    ```bash
    keytool -import -alias test -file downloaded_cert.pem -keystore downloaded_truststore.jks
    ```

    You’ll be prompted to enter a password for the keystore. Store this password in a secure location.

This truststore will allow Logstash to securely communicate with Elasticsearch using SSL/TLS by trusting the server’s certificate.    